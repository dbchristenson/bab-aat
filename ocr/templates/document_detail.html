{% extends "base.html" %}
{% load static list_extras %}

{% block title %} BAB OCR Document Detail {% endblock %}
{% block css %}
<link rel="stylesheet" type="text/css"
    href="{% static 'css/document_detail.css' %}">
{% endblock %}
{% block scripts %}
<script src="{% static 'js/document_detail.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const configRadios = document.querySelectorAll('.config-select');
        configRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.checked) {
                    const selectedId = this.value;
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('config_id', selectedId);
                    window.location.href = currentUrl.toString();
                }
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row g-3 mb-4 align-items-end">
        <h2 class="col-auto">Detections {{ document.document_number }}</h2>

        <div class="col-md-4">
            <label class="form-label" for="configDropdownButton">
                Select OCR Config (View)
            </label>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle w-100"
                    type="button" id="configDropdownButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="configDropdownLabel">
                        {{ selected_config.name | default:"Select Config" }}
                    </span>
                </button>

                <div class="dropdown-menu"
                    aria-labelledby="configDropdownButton"
                    style="max-height:200px; overflow-y:auto; padding:.5rem;">
                    {% for cfg_item in configs %}
                    <div class="form-check px-3">
                        <input class="form-check-input config-select"
                            type="radio" name="config_view"
                            id="configRadio{{ cfg_item.id }}"
                            value="{{ cfg_item.id }}" {% if
                            cfg_item.id==selected_config.id %}checked{% endif
                            %}>
                        <label class="form-check-label"
                            for="configRadio{{ cfg_item.id }}">
                            {{ cfg_item.name }}
                        </label>
                    </div>
                    {% endfor %}
                    {% if not configs %}
                    <a class="dropdown-item" href="#">No configs available</a>
                    {% endif %}
                </div><!-- /.dropdown-menu -->
            </div><!-- /.dropdown -->
        </div><!-- /.col -->
        <div class="col-md-3">
            {% if selected_config %}
            <form method="POST"
                action="{% url 'ocr:trigger_document_detections' document.id %}"
                class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="config_id"
                    value="{{ selected_config.id }}">
                <button type="submit" class="btn btn-primary w-100">Run OCR
                    with: {{ selected_config.name }}</button>
            </form>
            {% else %}
            <button type="button" class="btn btn-primary w-100" disabled>Run OCR
                (Select Config First)</button>
            {% endif %}
        </div>
        <div class="col-md-3">
            {% if draw_ocr %}
            <form method="POST"
                action="{% url 'ocr:trigger_draw_ocr' document.id %}"
                class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="config_id"
                    value="{{ selected_config.id }}">
                <button type="submit" class="btn btn-primary w-100">
                    Draw OCR Results
                </button>
            </form>
            {% else %}
            <button type="button" class="btn btn-primary w-100 disabled">
                No Tags Available
            </button>
            {% endif %}
        </div>

    </div><!-- /.row -->

    <!-- Detections -->
    {% if selected_config %}
    {% for data in page_detections %}
    <div class="card mb-4">
        <div class="card-header">
            <h4 style="color: white;">Page {{ data.page.page_number }}</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Annotated Image Display -->
                {% if data.annotated_image_url %}
                <div class="col-md-8">
                    <h5>OCR Results with Bounding Boxes:</h5>
                    <div class="text-center">
                        <img src="{{ data.annotated_image_url }}"
                            alt="Page {{ data.page.page_number }} with OCR annotations"
                            class="img-fluid border"
                            style="max-width: 100%; height: auto; max-height: 800px;">
                    </div>
                </div>
                {% endif %}

                <!-- Detection Text List -->
                {% if data.detections %}
                <div
                    class="{% if data.annotated_image_url %}col-md-4{% else %}col-12{% endif %}">
                    <h5>Detected Text ({{ data.detections|length }} items):
                    </h5>
                    <div style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Text</th>
                                    <th>Confidence</th>
                                    <th>Bounding Box</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in data.detections %}
                                <tr>
                                    <td>{{ d.created_at }}</td>
                                    <td>{{ d.text|truncatechars:30 }}</td>
                                    <td>{{ d.confidence|floatformat:2 }}
                                    </td>
                                    <td>{{ d.bbox }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- No Data Message -->
                {% if not data.detections and not data.annotated_image_url %}
                <div class="col-12">
                    <div class="alert alert-info">
                        <strong>No OCR results available for this
                            page.</strong>
                        {% if selected_config %}
                        Run OCR analysis first to see results.
                        {% else %}
                        Select an OCR configuration to begin.
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p>No pages found for this document, or no config selected.</p>
    {% endfor %}
    {% else %}
    <p>Please select an OCR Configuration to view or run detections.</p>
    <p><a href="{% url 'ocr:create_ocr_config' %}" class="btn btn-info">Create
            New OCR Config</a></p>
    {% endif %}
</div> <!-- Closing outer container -->
{% endblock %}